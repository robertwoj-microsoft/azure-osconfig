name: Fuzzer execution

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      arch:
        required: true
        type: string
      package-type:
        required: true
        type: string
      timeout-seconds:
        description: The maximum time in seconds to run the fuzzer.
        required: false
        type: number
        default: 600

jobs:
  package:
    uses: ./.github/workflows/package-build.yml
    with:
      target: ${{ inputs.target }}
      arch: ${{ inputs.arch }}
      artifact: ${{ inputs.target }}-fuzzer
      package-type: ${{ inputs.package-type }}
      build-fuzzers: true

  fuzzer-execution:
    needs: package
    runs-on: [self-hosted, 1ES.Pool=robertwoj-e2e-pool, '1ES.ImageOverride=${{ inputs.target }}']
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        id: download
        with:
          name: ${{ inputs.target }}-fuzzer

      - name: Install prerequisites
        run: |
          sudo apt update
          sudo apt install -y clang
          sudo chmod +x ${{ steps.download.outputs.download-path }}/fuzzer/osconfig-fuzzer
          mkdir /tmp/corpus
          mkdir /tmp/artifacts
          cp -r ${{ steps.download.outputs.download-path }}/src/fuzzer/seed_corpus/* /tmp/corpus
          cat /proc/sys/kernel/core_pattern
          sudo echo "/tmp/cores/osconfig-fuzzer" > /proc/sys/kernel/core_pattern
          sudo apt install -y gdb

      - name: Run osconfig-fuzzer
        working-directory: ${{ steps.download.outputs.download-path }}/fuzzer
        run: |
          sudo echo "/tmp/cores/osconfig-fuzzer" > /proc/sys/kernel/core_pattern
          core_location="/tmp/cores/"
          echo "Core location: ${core_location}"
          ldd ./osconfig-fuzzer
          ./osconfig-fuzzer -artifact_prefix=/tmp/artifacts/ -max_total_time=${{ inputs.timeout-seconds }} /tmp/corpus 2>&1 >/tmp/osconfig-stdout.log | tee /tmp/osconfig-fuzzer.log
          ls -l ${core_location}
          echo "bt" > commands.txt
          echo "quit" >> commands.txt
          gdb -batch -x commands.txt ./osconfig-fuzzer $(ls -t ${core_location} | head -n 1)

      - uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: ${{ inputs.target }}-logs
          path: |
            /tmp/osconfig-fuzzer.log
            /tmp/osconfig-stdout.log
            /tmp/cores
            ${{ steps.download.outputs.download-path }}/fuzzer/osconfig-fuzzer
            /tmp/artifacts
